<!DOCTYPE html>
<html>
	<head>
		<title>Geohackers</title>
		<script src="babylon.2.3.js"></script>
		<script src="data/compileddata.js"></script>
		<style>
		html, body {
			overflow: hidden;
			width   : 100%;
			height  : 100%;
			margin  : 0;
			padding : 0;
		}

		#renderCanvas {
			width   : 100%;
			height  : 100%;
			touch-action: none;
		}
		</style>
	</head>
	<body>
		<script type="application/vertexShader" id="vertexShaderCode">
			precision highp float;

			// Attributes
			attribute vec3 position;
			attribute vec3 normal;
			attribute vec2 uv;

			// Uniforms
			uniform mat4 worldViewProjection;
			uniform float time;
			uniform mat4 lightMatrix0;
			uniform mat4 world;


			// Varying
			varying vec3 vPosition;
			varying vec3 vNormal;
			varying vec2 vUV;
			varying vec4 vPositionFromLight0;
			varying float vHeight;

			uniform float amt1;
			uniform float amt2;
			uniform sampler2D img1;
			uniform sampler2D img2;

			void main(void) {

				float outheight =
					texture2D(img1, uv).a * amt1 +
					texture2D(img2, uv).a * amt2;



				vec3 v = position;
			//	v.x += sin(amt2 * 2.0 * position.y + (time)) * 1.0 * amt1;
				v.y += outheight * 4.0;





				
				vec4 worldPos = world * vec4(v, 1.0);

				gl_Position = worldViewProjection * worldPos;
				
				vPositionFromLight0 = lightMatrix0 * worldPos;

				vPosition = position;
				vNormal = normal;
				vUV = uv;
				vHeight = outheight;
			}
		</script>
		<script type="application/fragmentShader" id="fragmentShaderCode">
			precision highp float;

			// Varying
			varying vec3 vPosition;
			varying vec3 vNormal;
			varying vec2 vUV;
			varying vec4 vPositionFromLight0;

			// Uniforms
			uniform mat4 world;

			// Refs
			uniform vec3 cameraPosition;
			uniform sampler2D textureSampler;
			uniform sampler2D shadowSampler;
			uniform vec2 depthValues;
			varying float vHeight;

			uniform float debugamt;

			uniform float amt1;
			uniform float amt2;
			uniform sampler2D img1;
			uniform sampler2D img2;

			float unpack(vec4 color) {
				const vec4 bit_shift = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);
				return dot(color, bit_shift);
			}


			void main(void) {
				vec3 vLightPosition = vec3(0,20,10);
				
				// World values
				vec3 vPositionW = vec3(world * vec4(vPosition, 1.0));
				vec3 vNormalW = normalize(vec3(world * vec4(vNormal, 0.0)));
				vec3 viewDirectionW = normalize(cameraPosition - vPositionW);
				
				// Light
				vec3 lightVectorW = normalize(vLightPosition - vPositionW);
				
				// diffuse
				float ndl = max(0., dot(vNormalW, lightVectorW));
				//float ndl = 1.0;
				
				//Shadow - brightness
				float bri;

				vec3 directionToLight = vPositionW.xyz - vLightPosition;
		
				float depth = length(directionToLight)*1000.;
				depth = clamp(depth, 0., 1.0);
				
				//vec3 depth = vPositionFromLight0.xyz / vPositionFromLight0.w;
				//vec3 depth = lightVectorW.xyz / lightVectorW.w;
				vec3 depth2 = vec3(depth);
				vec2 uv = depth2.xy;

				if (uv.x < 0. || uv.x > 1.0 || uv.y < 0. || uv.y > 1.0)
				{
					bri = 0.0;
				}

				//float shadow = uv.x;//texture2D(textureSampler, uv).r + .01;
				//float shadow = unpack(texture2D(shadowSampler, uv));

				// if (depth2.z > shadow)
				// {
				// 	bri = 0.0;
				// }
				// else{
				// 	bri = 1.0;
				// }

				vec3 color = texture2D(textureSampler, vUV).rgb; ///2. + texture2D(textureSampler, vUV).rgb/2.;
				//vec3 color = texture2D(shadowSampler, uv).rgb; ///2. + texture2D(textureSampler, vUV).rgb/2.;
				
				// Specular
				vec3 angleW = normalize(viewDirectionW + lightVectorW);
				float specComp = max(0., dot(vNormalW, angleW));
				specComp = pow(specComp, max(1., 64.)) * 2.;

				if (debugamt > 0.5) {
					color *= 0.5;
					color += vec3(vHeight, vHeight, vHeight);
				}

				gl_FragColor = vec4(color * ndl + vec3(specComp), 1.0);// max(0.0, min(1.0, 6.0 - length(vUV - 0.5) * 12.0)) );
			}
		</script>
		<img src="res/avatar.png" style="position: absolute; left: 10px; top:10px; width: 110px; height: 110px">
		<pre id="taag_output_text" style="float:left;" class="fig" contenteditable="true">
		   _____            _                _                 
		  / ____|          | |              | |                
		 | |  __  ___  ___ | |__   __ _  ___| | _____ _ __ ___ 
		 | | |_ |/ _ \/ _ \| '_ \ / _` |/ __| |/ / _ \ '__/ __|
		 | |__| |  __/ (_) | | | | (_| | (__|   &lt;  __/ |  \__ \
		  \_____|\___|\___/|_| |_|\__,_|\___|_|\_\___|_|  |___/
		</pre>

		<p>
			<button id="img1"> Switch to Image 1 </button>
			<button id="img2"> Switch to Image 2 </button>
			<button id="img3"> Switch to Image 3 </button>
		</p>
<ul id="buttoncnt"></ul>
		<p>
			<input id="amt1" type="range" /> Layer 1 Amt
			<input id="amt2" type="range" /> Layer 2 Amt
			<input id="däbüg" type="checkbox" /> Degaüss
		</p>

		<canvas id="renderCanvas"></canvas>
		<script src="dal.js"></script>
		<script src="app.js"></script>
	</body>
</html>